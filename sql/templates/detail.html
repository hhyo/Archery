{% extends "base.html" %}
{% load i18n %}
{% load format_tags %}

{% block title %}{{ workflow_detail.workflow_name }}-{{ block.super }}{% endblock %}
{% block content %}
    <div class="form-inline">
        <h4 style="display: inline;">
            <a target="_blank"
               href="{{ workflow_detail.demand_url }}">{{ workflow_detail.workflow_name }}</a>
        </h4>
        <!-- Log -->
    <script>
        $(":input[id$='_osc']").bind('click', function () {
            let AllSelections = $("#osc_percent_list").bootstrapTable('getSelections');
            if (AllSelections.length === 1) {
                //get选择的sqlsha1
                let sqlsha1 = AllSelections[0]['SQLSHA1'];
                let command = '';
                let isContinue = true;

                // checkcommandValue
                switch (this.id) {
                    case 'pause_osc':
                        command = 'pause';
                        break;
                    case 'resume_osc':
                        command = 'resume';
                        break;
                    case 'kill_osc':
                        command = 'kill';
                        isContinue = confirm(gettext("Are you sure you want to terminate immediately? After termination, you need to manually clean up triggers and related intermediate tables!"));
                        break;
                    default:
                        alert(gettext('Command error!'))
                }
                if (isContinue) {
                    
                    $.ajax({
                        type: "post",
                        url: "/inception/osc_control/",
                        dataType: "json",
                        data: {
                            sqlsha1: sqlsha1,
                            workflow_id: "{{ workflow_detail.id }}",
                            command: command
                        },
                        complete: function () {
                        },
                        success: function (data) {
                            if (data.msg) {
                                alert(data.msg);
                            } else {
                                alert(gettext('Operation successful! Please refresh later to get the latest status.'));
                            }
                        }
                    })
                }

            } else {
                alert(gettext("Please select the process to terminate first"))
            }

        });
    </script>
    <!-- Status control -->
    <script>
        var workflow_id = "{{ workflow_detail.id }}";
        var status = $("#workflow_detail_status").text();
        var key;
        var retryCnt = 1;
        $(document).ready(function () {
            sessionStorage.setItem('sql_workflow_active_li_id', 'detail_tab');
            get_detail();
            if (status === "workflow_executing") {
                getWorkflowStatus(workflow_id);
            }
        });

        function getWorkflowStatus(workflow_id) {
            document.getElementById("workflow_detail_disaply").innerHTML = gettext("Confirming...");
            if (retryCnt <= 120) {
                clearTimeout(key);
                key = setTimeout(function () {
                    getWorkflowStatus(workflow_id);
                }, 2500);
                retryCnt++;
            } else {
                retryCnt = 1;
                alert(gettext("This ticket still hasn't finished executing after 2 minutes. Please try refreshing this page later."));
            }

            if (workflow_id > 0) {
                // console.log('get workflow status');
                $.ajax({
                    type: "post",
                    async: false,
                    url: "/getWorkflowStatus/",
                    dataType: "json",
                    data: {
                        workflow_id: workflow_id
                    },
                    complete: function () {
                        if (wfStatus !== -1 && wfStatus !== "workflow_executing") {
                            window.location.reload(true);
                        }
                    },
                    success: function (data) {
                        wfStatus = data.status;
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(errorThrown);
                    }
                });
            } else {
                alert(gettext("Invalid parameter"))
            }
        }


    </script>
    <!-- TAB control -->
    <script>
        //Tab switch, save the previously active tab id
        $(function () {
            $("#nav-tabs").on('shown.bs.tab', "li", function (e) {
                var active_li_id = $(e.target).parents().attr('id');
                sessionStorage.setItem('sql_workflow_active_li_id', active_li_id);
                //The previously active tab id
                if (active_li_id === 'detail_tab') {
                    get_detail();
                } else if (active_li_id === 'logs_tab') {
                    get_logs();
                }
            });
        });
    </script>
    <!-- Download exported file -->
    <script>
        $('#btnDownload').click(async function() {
            const $btn = $(this);
            $btn.prop('disabled', true);
            const originalText = $btn.html();
            $btn.html('<i class="fa fa-spinner fa-spin"></i> ' + gettext('Preparing download...'));
                
            try {
                const workflow_id = "{{ workflow_detail.id }}";
                const file_name = "{{ workflow_detail.file_name }}";
                const filePath = `/downloadfile/?file_name=${encodeURIComponent(file_name)}&workflow_id=${workflow_id}`;
            
                
                const typeCheck = await fetch(filePath, {
                    method: 'HEAD',
                    cache: 'no-store'
                });
            
                if (typeCheck.headers.get('content-type')?.includes('application/json')) {
                    
                    const res = await fetch(filePath);
                    const data = await res.json();
                    
                    if (data.error) {
                        throw new Error(data.error);  
                    }
                    
                    if (data.type === 'redirect') {
                        window.location.href = data.url;
                        return;
                    }
                    throw new Error(gettext('Unknown response format'));
                }
            
                
                const a = document.createElement('a');
                a.href = filePath;
                a.download = file_name;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
            
            } catch (error) {
                console.error('Download failed:', error);
                alert(gettext('Download error:') + ' ' + (error.message || gettext('Server connection failed')));
            } finally {
                
                if (!$btn.prop('disabled')) return;
                setTimeout(() => {
                    $btn.prop('disabled', false);
                    $btn.html(originalText);
                }, 3000);
            }
        });
    </script>

{% endblock %}

