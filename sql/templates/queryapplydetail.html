{% extends "base.html" %}
{% load i18n %}
{% load format_tags %}
{% block title %}{{ workflow_detail.title }}-{{ block.super }}{% endblock %}
{% block content %}
    <h4 style="display: inline;">Ticket Nameï¼š<span>{{ workflow_detail.title }}</span></h4>
    &nbsp;&nbsp;&nbsp;
    <!--Only submitter can submit to other instances-->
    {% if user.username == workflow_detail.engineer %}
        <a type='button' id="btnSubmitOtherCluster" class='btn btn-warning' href="/submitotherinstance/">Deploy to other instances</a>
    {% endif %}
    <input type="hidden" id="sqlMaxRowNumber" value="{{ rows|length }}">
    <input type="hidden" id="editSqlContent" value="{{ workflow_detail.sql_content }}"/>
    <hr>
    <h4>
        Approval Flow
    </h4>
    <h5>
    {% include "workflow_display.html" %}
    <h4>
        Other Info
    </h4>
    <table data-toggle="table" class="table table-striped table-hover"
           style="table-layout:inherit;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        <thead>
        <tr>
            <th>
                {% trans "Applicant" %}
            </th>
            <th>{% trans "Instances" %}</th>
            <th>
                {% trans "Permission Level" %}
            </th>
            <th>
                Database
            </th>
            <th>
                {% trans "Result Set" %}
            </th>
            <th>
                {% trans "Valid Date" %}
            </th>
            <th>
                {% trans "Apply Time" %}
            </th>
            <th>
                {% trans "Current Status" %}
            </th>
            <th>
                Group
            </th>
        </tr>
        </thead>
        <tbody>
        <tr class="success">
            <td>
                {{ workflow_detail.user_display }}
            </td>
            <td>
                {{ workflow_detail.instance.instance_name }}
            </td>
            <td>
                {{ workflow_detail.get_priv_type_display }}
            </td>
            <td>
                {{ workflow_detail.db_list| slice:"32" }}
            </td>
            <td>
                {{ workflow_detail.limit_num }}
            </td>
            <td>
                {{ workflow_detail.valid_date }}
            </td>
            <td>
                {{ workflow_detail.create_time }}
            </td>
            <td>
                {% if workflow_detail.status == 0 %}
                    <b style="color: red">{% trans "Pending Review" %}</b>
                {% elif workflow_detail.status == 1 %}
                    <b style="color: green">{% trans "Approved" %}</b>
                {% elif workflow_detail.status == 2 %}
                    <b style="color: red">{% trans "Review Rejected" %}</b>
                {% elif workflow_detail.status == 3 %}
                    <b style="color: red">{% trans "Review Cancelled" %}</b>
                {% endif %}
            </td>
            <td>
                {{ workflow_detail.group_name }}
            </td>
        </tr>
        </tbody>
    </table>
    <br>
    <div class="panel panel-default">
        <div class="panel-heading">
            {% if workflow_detail.priv_type == 1 %}
                {% trans "Database List" %}
            {% elif workflow_detail.priv_type == 2 %}
                {% trans "Table List" %}
            {% endif %}
        </div>
        <div class="panel-body">
            {% if workflow_detail.priv_type == 1 %}
                {% format_str workflow_detail.db_list %}
            {% elif workflow_detail.priv_type == 2 %}
                {% format_str workflow_detail.table_list %}
            {% endif %}
        </div>
    </div>
    <!-- Last operation info -->
    {% if last_operation_info %}
        <table data-toggle="table" class="table table-striped table-hover">
            <thead>
            <tr>
                <th>
                    Operation Info
                </th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>
                    {{ last_operation_info }}
                </td>
            </tr>
            </tbody>
        </table>
        <br>
    {% endif %}
    {% if workflow_detail.status == 0 %}
        {% if is_can_review %}
            <textarea id="remark" name="remark" class="form-control" data-name="{% trans 'Review Remarks' %}"
                      placeholder="Please fill inReviewRemarks" rows=3></textarea>
            <br>
            <form action="/query/privaudit/" method="post" style="display:inline-block;">
                {% csrf_token %}
                <input type="hidden" name="apply_id" value="{{ workflow_detail.apply_id }}">
                <input type="hidden" id="audit_status" name="audit_status" value="1">
                <input type="submit" id="btnPass" onclick="loading(this)" class="btn btn-success" value="{% trans 'Approved' %}"/>
            </form>

            <form id="form-cancel" action="/query/privaudit/" method="post" style="display:inline-block;">
                {% csrf_token %}
                <input type="hidden" name="apply_id" value="{{ workflow_detail.apply_id }}">
                <input type="hidden" id="audit_status" name="audit_status" value="2">
                <input type="hidden" id="audit_remark" name="audit_remark" value="">
                <input type="button" id="btnReject" class="btn btn-default" value="{% trans 'Terminate Process' %}"/>
            </form>
        {% endif %}
    {% endif %}
{% endblock content %}

{% block js %}
    <script>
        
        function loading(obj) {
            $(obj).button('loading').delay(2500).queue(function () {
                $(obj).button('reset');
                $(obj).dequeue();
            });
        }

        
        $("#btnReject").click(function () {
            //Get form object, check input, approve and submit
            $("#audit_remark").val($("#remark").val());
            var formCancel = $("#form-cancel");
            if ($("#audit_remark").val()) {
                $(this).button('loading').delay(2500).queue(function () {
                    $(this).button('reset');
                    $(this).dequeue();
                });
                formCancel.submit();
            } else {
                alert('Please fill inReviewRemarks')
            }
        })
    </script>
{% endblock %}
