{% extends "base.html" %}
{% load i18n %}

{% block content %}
    <div class="row clearfix">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">{% trans "SQL Deployment" %}</div>
                <div class="panel-body">
                    <form id="form-submitsql" class="form-horizontal">
                        {% csrf_token %}
                        <input type="hidden" id="workflow_id" name="workflow_id"/>
                        <div class="col-md-9 column">
                            <pre id="sql_content_editor" style="min-height:450px"></pre>
                        </div>
                        <div style="display: none" class="col-md-8 column">
                            <textarea id="sql_content" name="sql_content" class="form-control" data-name="SQLContent"
                                      data-placeholder="SQLContent cannot be empty！"
                                      placeholder="Please submit hereSQL，Please end with semicolon。" rows=20
                                      required></textarea>
                        </div>
                        <div class="col-md-3 column">
                            <div class="form-group">
                                <input id="sql-upload" name="sql-upload" accept=".sql" type="file" class="file-loading">
                            </div>
                            <div class="form-group">
                                <input id="workflow_name" type="text" autocomplete="off" name="workflow_name"
                                       class="form-control"
                                       data-name="Deployment ticket name" data-placeholder="Please enterDeployment ticket name!"
                                       placeholder="Please enterDeployment ticket name，如:XX项目会员功能建Table"
                                       required>
                            </div>
                            <div class="form-group">
                                <input id="demand_url" type="text" autocomplete="off" name="demand_url"
                                       class="form-control"
                                       data-name="{% trans 'Requirement Link' %}" data-placeholder="请提供需求链接，记录工单需求Info！"
                                       placeholder="Please enter需求链接">
                            </div>
                            <div class="form-group">
                                <select id="group_name" name="group_name"
                                        class="selectpicker show-tick form-control bs-select-hidden"
                                        data-name="Group" data-placeholder="Select Group！"
                                        title="Select Group"
                                        data-live-search="true" data-live-search-placeholder="Search您所在的Group" required>
                                    {% for group in group_list %}
                                        <option value="{{ group.group_name }}"
                                                group-id="{{ group.group_id }}">{{ group.group_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="instance_name" name="instance_name"
                                        class="selectpicker show-tick form-control bs-select-hidden"
                                        data-name="{% trans 'Instances' %}" data-placeholder="Select Instance！"
                                        title="Select Instance"
                                        data-live-search="true" data-live-search-placeholder="{% trans 'Search instances in your group' %}" required>
                                {% for name, engine in engines.items %}
                                    <optgroup id="optgroup-{{ name }}" label="{{ engine.name }}"></optgroup>
                                {%  endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="db_name" name="db_name"
                                        class="form-control selectpicker show-tick bs-select-hidden"
                                        data-name="Database" data-placeholder="Select Database！"
                                        data-live-search="true" data-live-search-placeholder="Search要Submit的Database"
                                        title="Select Database"
                                        required>
                                    <option value="is-empty" disabled="" selected="selected">{% trans "Select Database:" %}</option>
                                </select>
                            </div>
                            {% if enable_backup_switch %}
                                <div id="div-backup" class="form-group">
                                    <select id="is_backup" name="is_backup"
                                            class="selectpicker show-tick form-control bs-select-hidden"
                                            data-name="YesNo选择备份"
                                            title="Please selectYesNo需要备份"
                                            data-placeholder="Please selectYesNo要备份" required>
                                        <option value=True selected="selected">备份SQL</option>
                                        <option value=False>不备份SQL</option>
                                    </select>
                                </div>
                            {% endif %}
                            <!--可Execute范围Time-->
                            <div class='form-group'>
                                <input type="hidden" id="run_date_start" name="run_date_start">
                                <input type="hidden" id="run_date_end" name="run_date_end">
                                <div class='input-group date'>
                                    <input type="text" id="run_date_range" readonly
                                           value="Please select可Execute Time范围"
                                           style="background-color: #fff;color: #999 "
                                           class="form-control "/>
                                    <span class="input-group-addon"><span
                                            class="glyphicon glyphicon-time"></span></span>
                                </div>
                            </div>
                            <!--Approval Flow程-->
                            <input type="hidden" id="workflow_auditors" name="workflow_auditors" data-name="Approval Flow程"
                                   data-placeholder="请ConfigApproval Flow程！" required>
                            <div id="div-workflow_auditors" class="form-group" style="display: none">
                                <p class="bg-primary">&nbsp&nbsp&nbspApproval Flow程：<b id="workflow_auditors_display"></b></p>
                            </div>
                            <!--button-->
                            <div class="form-group">
                                <button type="button" id="btn-format" class="btn btn-info">{% trans "Format" %}</button>
                                <button type="button" id="btn-autoreview" data-loading-text="检测中..."
                                        class="btn btn-danger">SQL检测
                                </button>
                                <button type="button" id="btn-submitsql" data-loading-text="Submit中..."
                                        class="btn btn-success disabled" disabled>
                                    SQLSubmit
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-12 column">
            <div class="panel panel-default">
                <div class="panel-heading">
                    检测Result
                </div>

                <div class="panel-body">
                    <div class="table-responsive">
                        <table id="inception-result" data-toggle="table" class="table table-striped table-hover"
                               style="table-layout:inherit;overflow:hidden;white-space:nowrap;word-break:break-word;text-overflow:ellipsis;display: none"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ReviewInfo确认 -->
    <div class="modal fade" id="submitConfirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header ">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">×</span></button>
                    <h4 class="modal-title text-danger">SubmitInfo确认</h4>
                </div>
                <div class="modal-body">
                    <p>Submit的SQL经检测仍存在<font color="red" size="5"><b id="CheckWarningCount"></b></font>个WarningInfo和<font
                            color="red" size="5"><b id="CheckErrorCount"></b></font>个errorInfo，请按照平台规范仔细Check！<br>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">{% trans "Cancel" %}</button>
                    <button id="submitsqlconfirm" type="button" class="btn btn-danger" data-dismiss="modal">ConfirmSubmit
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block js %}
    {% load static %}
    <link href="{% static 'bootstrap-fileinput/css/fileinput.min.css' %}" rel="stylesheet">
    <link href="{% static 'daterangepicker/css/daterangepicker.css' %}" rel="stylesheet" type="text/css"/>
    <script src="{% static 'ace/ace.js' %}"></script>
    <script src="{% static 'ace/ext-language_tools.js' %}"></script>
    <script src="{% static 'ace/mode-mysql.js' %}"></script>
    <script src="{% static 'ace/theme-github.js' %}"></script>
    <script src="{% static 'ace/snippets/mysql.js' %}"></script>
    <script src="{% static 'ace/ace-init.js' %}"></script>
    <script src="{% static 'bootstrap-fileinput/js/fileinput.min.js' %}"></script>
    <script src="{% static 'bootstrap-fileinput/js/locales/zh.js' %}"></script>
    <script src="{% static 'daterangepicker/js/moment.min.js' %}"></script>
    <script src="{% static 'daterangepicker/js/daterangepicker.js' %}"></script>

    <!--InitializeTime控件 -->
    <script>
        $("#run_date_range").daterangepicker({
            timePicker: true,
            timePicker24Hour: true,
            autoApply: true,
            autoUpdateInput: false,
            opens: "left",
            drops: "up",
            minDate: moment().startOf('minutes'),
            startDate: moment().startOf('hour'),
            endDate: moment().startOf('hour'),
            locale: {
                "applyLabel": "Confirm",
                "cancelLabel": "清空",
                "daysOfWeek": ["日", "一", "二", "三", "四", "五", "六"],
                "monthNames": ["一months", "二months", "三months", "四months", "五months", "六", "七months", "八months", "九months", "十months", "十一months", "十二months"],
                "firstDay": 1
            },
        }).on('apply.daterangepicker', function (ev, picker) {
            $(this).css("color", "#333");
            $("#run_date_start").val(picker.startDate.format('YYYY-MM-DD HH:mm'));
            $("#run_date_end").val(picker.endDate.format('YYYY-MM-DD HH:mm'));
            $(this).val(picker.startDate.format('MM-DD HH:mm') + ' / ' + picker.endDate.format('MM-DD HH:mm'));
        }).on('cancel.daterangepicker', function (ev, picker) {
            $(this).css("color", "#999");
            $(this).val('Please select可Execute Time范围');
            $("#run_date_start").val('');
            $("#run_date_end").val('');
        });
    </script>
    <!--upload -->
    <script>
        //InitializeUpload控件
        function init_upload() {
            $("#sql-upload").fileinput({
                language: 'zh',
                allowedFileExtensions: ['sql'],
                showCaption: true,
                initialCaption: '仅支持10M内的SQL文件',
                defaultPreviewContent: '仅支持10M内的SQL文件',
                showUpload: false,     
                showPreview: false,    
                //maxFileSize: 10240
            }).on('fileloaded', function (event, data, previewId, index) {
                if (data.size <= 10240 * 1024) {
                    loadsql();
                } else {
                    $('#sql-upload').fileinput('reset');
                    alert('文件Size超过10M，请重新选择');
                }
            }).on('fileclear', function (event) {
                editor.setValue("");
            });
        }

        
        function loadsql() {
            //get文件
            var file = $("#sql-upload")[0].files[0];

            
            var reader = new FileReader();

            
            var sqlFile;

            
            reader.onload = function (e) {
                var sqlFile = e.target.result;
                var value = editor.getValue() + sqlFile;
                editor.setValue(value);
                editor.clearSelection();
            };

            
            reader.readAsText(file);
        }
    </script>
    <!--ace -->
    <script>
        
        $("#instance_name").change(function () {
            var optgroup = $('#instance_name :selected').parent().attr('label');
            $("#div-backup").show();
            if (optgroup != "MySQL" && optgroup != "Oracle") {
                $("#div-backup").hide();
                $("#is_backup").val("False");
            }
            
            $.ajax({
                type: "get",
                url: "/instance/instance_resource/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val(),
                    resource_type: "database"
                },
                complete: function () {
                    var pathname = window.location.pathname;
                    if (pathname === "/editsql/") {
                        
                        $("#db_name").selectpicker('val', sessionStorage.getItem('editDbname'));
                        if ($("#db_name").val()) {
                            $("#db_name").selectpicker().trigger("change");
                        }
                    }
                },
                success: function (data) {
                    if (data.status === 0) {
                        var result = data.data;
                        $("#db_name").empty();
                        for (var i = 0; i < result.length; i++) {
                            var name = "<option value=\"" + result[i] + "\">" + result[i] + "</option>";
                            $("#db_name").append(name);
                        }
                        $('#db_name').selectpicker('render');
                        $('#db_name').selectpicker('refresh');
                        
                        setDbsCompleteData(result)
                    } else {
                        alert(data.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        });
        //Database变更getTableName补全Tip
        $("#db_name").change(function () {
            
            $.ajax({
                type: "get",
                url: "/instance/instance_resource/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val(),
                    db_name: $("#db_name").val(),
                    resource_type: "table"
                },
                complete: function () {
                },
                success: function (data) {
                    if (data.status === 0) {
                        
                        setTablesCompleteData(data.data)
                    } else {
                        alert(data.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        });
    </script>
    <!--validate -->
    <script>
        function validateForm(element) {
            var result = true;
            element.find('[required]').each(
                function () {
                    var fieldElement = $(this);
                    var fieldId = $(this).attr('id');
                    
                    var value = fieldElement.val() || '';
                    if (value) {
                        value = value.trim();
                    }
                    if (!value || value === fieldElement.attr('data-placeholder')) {
                        alert(fieldElement.attr('data-placeholder'));
                        result = false;
                        return result;
                    }
                    if(fieldId == "workflow_name" && value.length>=50){
                        alert("Deployment ticket name/Ticket Name不能超过50个字符！");
                        result = false;
                        return result;
                    }
                }
            );
            return result;
        }

        
        $("#btn-format").click(function () {
                var select_sqlContent = editor.session.getTextRange(editor.getSelectionRange());
                if (select_sqlContent) {
                    var sqlContent = select_sqlContent
                } else {
                    var sqlContent = editor.getValue();

                }
                var sqlContent = window.sqlFormatter.format(sqlContent);
                editor.setValue(sqlContent);
                editor.clearSelection();
            }
        );
    </script>
    <!--check-->
    <script>
        editor.on('change', function () {
            $('#btn-submitsql').addClass('disabled').prop("disabled", this);
        });

        function checkRunDate(gap = 60) {
            
            var start = $("#run_date_start").val();
            var end = $("#run_date_end").val();
            if (start && end) {
                var realGap = ((new Date(end)).getTime() - (new Date(start)).getTime()) / (1000 * 60)
                if (realGap >= gap) {
                    return true
                } else {
                    alert("可Execute Time范围不应该短于" + gap + "minutes");
                    return false
                }
            }
            return true
        }
        
        function removeStartsWith(str,prefix) {
            if (typeof str !== 'string' || str === null) {
                return str;
            }
            if (str.startsWith(prefix)) {
                return str.substring(prefix.length);
            }
            return str;
        };
        $("#btn-autoreview").click(function () {
            
            const sqlTips = "-- 请在此输入SQL，以分号结尾，仅支持DML和DDL语句，查询语句请使用SQL查询功能。\n";
            var editorValue=editor.getValue();
            // DeleteDefault的Tipstring。
            editorValueRemove=removeStartsWith(editorValue,sqlTips);
            if(editorValue!==editorValueRemove)
            {
                editor.setValue(editorValueRemove);
            }
            $("#sql_content").val(editorValueRemove);
            $("#sql_content").val(editor.getValue());
            if (validateForm($("#form-submitsql")) && checkRunDate()) {
                autoreview();
            }
        });

        //SQLSubmit
        $("#btn-submitsql").click(function () {
            //getformobject，check输入，ApprovethenSubmit
            $("#sql_content").val(editor.getValue());
            if (validateForm($("#form-submitsql")) && checkRunDate()) {
                //checkYesNo需要弹出Tip
                var CheckWarningCount = sessionStorage.getItem('CheckWarningCount');
                var CheckErrorCount = sessionStorage.getItem('CheckErrorCount');
                $("#CheckWarningCount").text(CheckWarningCount);
                $("#CheckErrorCount").text(CheckErrorCount);
                if (CheckWarningCount > 0 || CheckErrorCount > 0) {
                    $('#submitConfirm').modal('show');
                } else {
                    sqlSubmit()
                }
            }
        });

        
        $("#submitsqlconfirm").click(function () {
            sqlSubmit()
        });

        function autoreview() {
            
            $.ajax({
                type: "post",
                url: "/api/v1/workflow/sqlcheck/",
                dataType: "json",
                contentType: 'application/json;',
                data: JSON.stringify({
                    full_sql: editor.getValue(),
                    instance_id: $("#instance_name option:selected").attr("instance-id"),
                    db_name: $("#db_name").val()
                }),
                beforeSend: function (xhr) {
                    $('#btn-autoreview').button('loading')
                },
                complete: function () {
                    $('#btn-autoreview').button('reset')
                },
                success: function (data) {
                    var result = data;
                    //InitializeTable结构显示
                    
                    var columns = [];
                    $.each(result['column_list'], function (i, column) {
                        columns.push({"field": i, "title": column, "sortable": true});
                    });
                    $("#inception-result").bootstrapTable('destroy').bootstrapTable({
                            data: result['rows'],
                            columns: [{
                                title: 'ID',
                                field: 'id',
                                sortable: true
                            }, {
                                title: 'SQL语句',
                                field: 'sql',
                                formatter: function (value, row, index) {
                                    var sql = value.replace(/\n/g, '<br>').replace(/\s/g, '&nbsp;');
                                    if (value.length > 50) {
                                        return sql.substr(0, 50) + '...';
                                    } else {
                                        return sql
                                    }
                                }
                            }, {
                                title: '扫描/影响行数',
                                field: 'affected_rows',
                                sortable: true
                            }, {
                                title: 'ReviewStatus',
                                field: 'errlevel',
                                sortable: true,
                                formatter: function (value, row, index) {
                                    if (String(value) === '0') {
                                        return 'pass'
                                    } else if (String(value) === '1') {
                                        return 'warning'
                                    } else if (String(value) === '2') {
                                        return 'error'
                                    }
                                }
                            }, {
                                title: 'ReviewInfo',
                                field: 'errormessage',
                                formatter: function (value, row, index) {
                                    if (value === null) {
                                        return value
                                    }
                                    return value.replace(/\n/g, '<br>');
                                }
                            }],
                            rowStyle: function (row, index) {
                                var style = "";
                                if (row.errlevel === 1) {
                                    style = 'warning';
                                } else if (row.errlevel === 2) {
                                    style = 'danger';
                                }
                                return {classes: style}
                            },
                            escape: true,                       
                            striped: true,                      //Show row stripes
                            cache: false,                       //Use cache，Default istrue，so usually need to set this property（*）
                            sortable: true,                     //Enable sorting
                            //sortOrder: "desc",                   //Sort order
                            //sortName: 'errormessage',           
                            pagination: true,                   //Show pagination（*）
                            sidePagination: "client",           //Pagination mode：clientClient-side pagination，serverServer-side pagination（*）
                            pageNumber: 1,                      //Initialize load first page，Default first page,and record
                            pageSize: 500,                     //Records per page（*）
                            pageList: [500, 1000, 5000],       //Selectable rows per page（*）
                            search: true,                      //Show table search
                            strictSearch: false,                //Exact match search
                            showColumns: true,                  //Show all columns（Select columns to display）
                            showRefresh: false,                  //Show refresh button
                            showExport: true,
                            exportDataType: "all",
                            minimumCountColumns: 1,             //Minimum columns allowed
                            uniqueId: "id",                     //Unique identifier for each row，Usually primary key column
                            showToggle: true,                   //Show toggle button for detail/list view
                            cardView: false,                    //Show detail view
                            detailView: true,                  //Show parent-child table
                            
                            detailFormatter: function (index, row) {
                                var html = [];
                                $.each(row, function (key, value) {
                                    if (key === 'sql') {
                                        //let sql = window.sqlFormatter.format(key);
                                        let sql = value;
                                        
                                        sql = sql.replace(/&/g, "&amp;");
                                        sql = sql.replace(/</g, "&lt;");
                                        sql = sql.replace(/>/g, "&gt;");
                                        sql = sql.replace(/"/g, "&quot;");
                                        
                                        sql = sql.replace(/\r\n/g, "<br>");
                                        sql = sql.replace(/\n/g, "<br>");
                                        
                                        sql = sql.replace(/\s/g, "&nbsp;");
                                        html.push('<span>' + sql + '</span>');

                                    }
                                });
                                return html.join('');
                            }
                        }
                    );
                    
                    sessionStorage.setItem('CheckWarningCount', result.warning_count);
                    sessionStorage.setItem('CheckErrorCount', result.error_count);
                    $("#inception-result").show();
                    $('#btn-submitsql').button('reset').removeClass('disabled').prop("disabled", false);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    if (XMLHttpRequest.responseJSON) {
                        alert(XMLHttpRequest.responseText)
                    } else {
                        alert(errorThrown);
                    }
                }
            });

        }

        function sqlSubmit() {
            let formData = $('#form-submitsql').serializeArray().reduce(function (obj, item) {
                obj[item.name] = item.value;
                return obj;
            }, {})
            $.ajax({
                type: "post",
                url: "/api/v1/workflow/",
                dataType: "json",
                contentType: 'application/json;',
                data: JSON.stringify({
                        workflow: {
                            workflow_name: formData.workflow_name,
                            demand_url: formData.demand_url,
                            group_id: $("#group_name option:selected").attr("group-id"),
                            instance: $("#instance_name option:selected").attr("instance-id"),
                            db_name: formData.db_name,
                            is_backup: formData.is_backup === 'True',
                            run_date_start: formData.run_date_start,
                            run_date_end: formData.run_date_end,
                            is_offline_export: 0,
                        },
                        sql_content: formData.sql_content
                    }
                ),
                beforeSend: function (xhr) {
                    $('#btn-submitsql').button('loading')
                },
                complete: function () {
                    $('#btn-submitsql').button('reset')
                },
                success: function (data) {
                    window.location.href = "/detail/"+ data.workflow_id
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    if (XMLHttpRequest.responseJSON) {
                        alert(XMLHttpRequest.responseText)
                    } else {
                        alert(errorThrown);
                    }
                }
            });

        }
    </script>
    <!--group -->
    <script>
        // getInstanceInfo和Approval Flow程
        $("#group_name").change(function () {
            $.ajax({
                type: "post",
                url: "/group/instances/",
                dataType: "json",
                data: {
                    group_name: $("#group_name").val(),
                    tag_code: 'can_write'
                },
                complete: function () {
                    var pathname = window.location.pathname;
                    if (pathname === "/editsql/") {
                        
                        $('#instance_name').selectpicker('val', sessionStorage.getItem('editClustername'));
                        if ($("#instance_name").val()) {
                            $("#instance_name").selectpicker().trigger("change");
                        }
                    }
                },
                success: function (data) {
                    if (data.status === 0) {
                        $("optgroup[id^='optgroup']").empty();
                        let result = data['data']
                        const supportDb = [ {% for name in engines.keys %}"{{ name }}", {% endfor %}]
                        for (let i of result) {
                            let instance = "<option value=\"" + i.instance_name + "\" instance-id=" + i.id + ">" + i.instance_name + "</option>";
                            if (supportDb.indexOf(i.db_type) !== -1) {
                                $("#optgroup-" + i.db_type).append(instance);
                            }
                        }
                        $('#instance_name').selectpicker('render').selectpicker('refresh');
                        $("#db_name").empty().selectpicker('render').selectpicker('refresh');
                    } else {
                        alert(data.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
            $.ajax({
                type: "post",
                url: "/group/auditors/",
                dataType: "json",
                data: {
                    group_name: $("#group_name").val(),
                    workflow_type: 2
                },
                complete: function () {
                },
                success: function (data) {
                    if (data.status === 0) {
                        var result = data.data;
                        $("#workflow_auditors").val(result['auditors']);
                        $("#workflow_auditors_display").text(result['auditors_display']);
                        $("#div-workflow_auditors").show();
                    } else {
                        alert(data.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        });
    </script>
    <!--init -->
    <script>
        $(document).ready(function () {
            // InitializeUpload控件
            init_upload();
            
            sessionStorage.removeItem('editWorkflowDetailId');
            var pathname = window.location.pathname;
            if (pathname == "/editsql/") {
                $("#workflow_name").val(sessionStorage.getItem('editWorkflowNname'));
                $("#demand_url").val(sessionStorage.getItem('editDemandUrl'));
                $("#group_name").val(sessionStorage.getItem('editGroup'));
                $("#demand_url").val(sessionStorage.getItem('editDemandUrl'));
                editor.setValue(sessionStorage.getItem('editSqlContent'));
                editor.clearSelection();
                $("#is_backup").val(sessionStorage.getItem('editIsbackup'));
            } else if (pathname === "/submitotherinstance/") {
                $("#workflow_name").val(sessionStorage.getItem('editWorkflowNname'));
                $("#demand_url").val(sessionStorage.getItem('editDemandUrl'));
                $("#group_name").val(sessionStorage.getItem('editGroup'));
                editor.setValue(sessionStorage.getItem('editSqlContent'));
                editor.clearSelection();
                $("#is_backup").val(sessionStorage.getItem('editIsbackup'));
            } else if (pathname === "/submitsql/") {
                
                editor.setValue("");
                $(".selectpicker").selectpicker('val', '');
                $(".selectpicker").selectpicker('render');
                $(".selectpicker").selectpicker('refresh');
            }
            if ($("#group_name").val()) {
                $("#group_name").trigger("change");
            }
        });
    </script>
{% endblock %}
