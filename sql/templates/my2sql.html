{% extends "base.html" %}
{% load i18n %}

{% block content %}
    <div class="row clearfix">
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">
                    {% trans "Operations" %}Options
                </div>
                <div class="panel-body">
                    <div class="form-group">
                        <h5 class="control-label text-bold">{% trans "Select Instance:" %}</h5>
                        <div class="form-group">
                            <select id="instance_name" name="instance_name"
                                    class="selectpicker show-tick form-control bs-select-hidden"
                                    title="{% trans 'Select Instance:' %}"
                                    data-live-search="true" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-group">
                            <div class="checkbox">
                                <label>
                                    <input id="save_sql" type="checkbox">
                                    Save to file(Async operation)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <h5 class="control-label text-bold">Parse mode：</h5>
                        <div class="form-group">
                            <div class="checkbox">
                                <label>
                                    <input id="rollback" type="checkbox">
                                    -work-type rollback
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input id="ignore_primary_key" type="checkbox">
                                    -ignore-primaryKey-forInsert
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input id="full_columns" type="checkbox">
                                    -full-columns
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input id="no_db_prefix" type="checkbox">
                                    -do-not-add-prifixDb
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input id="file_per_table" type="checkbox">
                                    -file-per-table
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input id="extra_info" type="checkbox">
                                    -add-extraInfo
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                    <h5 class="control-label text-bold">{% trans 'Parse Threads:' %}</h5>
                        <div class="form-group">
                            <input type="number" class="form-control" id="threads" placeholder="{% trans 'Default 4' %}"

                                   onkeyup="if(event.keyCode !=37 && event.keyCode != 39)value=value.replace(/\D/g,'')">
                        </div>
                    </div>
                    <div class="form-group">
                        <h5 class="control-label text-bold">{% trans "Parse Range Control:" %}</h5>
                        <div class="form-group">
                            <input type="number" class="form-control" id="num" placeholder="{% trans 'Parse row count per page, default 30' %}"
                                   onkeyup="if(event.keyCode !=37 && event.keyCode != 39)value=value.replace(/\D/g,'')">
                        </div>
                        <div class="form-group">
                            <select id="start_file" class="selectpicker form-control"
                                    title="{% trans 'Start parse file:' %}"
                                    required>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-control" id="start_pos" placeholder="{% trans 'Start parse position (optional)' %}"
                                   onkeyup="if(event.keyCode !=37 && event.keyCode != 39)value=value.replace(/\D/g,'')">
                        </div>
                        <div class="form-group">
                            <select id="end_file" class="selectpicker form-control"
                                    title="{% trans 'End parse file (optional):' %}"
                                    required>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-control" id="end_pos" placeholder="{% trans 'End parse position (optional)' %}"
                                   onkeyup="if(event.keyCode !=37 && event.keyCode != 39)value=value.replace(/\D/g,'')">
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control form_datetime" id="start_time"
                                   placeholder="{% trans 'Start parse time (not recommended)' %}">
                        </div>
                        <div class="form-group">
                            <input type="text" class="form-control form_datetime" id="stop_time"
                                   placeholder="{% trans 'End parse time (optional)' %}">
                        </div>
                    </div>
                    <div class="form-group">
                        <h5 class="control-label text-bold">{% trans "Object Filter:" %}</h5>
                        <div class="form-group">
                            <select id="only_schemas" class="selectpicker form-control "
                                    data-live-search="true"
                                    title="{% trans 'Database filter (optional):' %}"
                                    required>
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="only_tables" class="selectpicker form-control "
                                    data-live-search="true"
                                    title="{% trans 'Table filter (optional):' %}"
                                    multiple="multiple" required>
                            </select>
                        </div>
                        <select id="sql_type" class="selectpicker form-control "
                                data-live-search="true"
                                title="{% trans 'Type filter (optional):' %}"
                                multiple="multiple" required>
                            <option value="insert">INSERT</option>
                            <option value="update">UPDATE</option>
                            <option value="delete">DELETE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button id="my2sql" class="btn btn-danger">getSQL</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9 column">
            <div class="panel panel-default">
                <div class="panel-heading">
                    {% trans "SQL Statements" %}
                </div>
                <div class="panel-body">
                    <h5 class="control-label text-bold" style="color: red">
                        <b>{% trans "Frontend display count is controlled by parse range parameter. If 'Save to file' is checked, complete SQL file will be asynchronously saved to downloads directory. Notification will be sent to operator after execution ends (if message notification is enabled)." %}</b>
                    </h5>
                    <br>
                    <table id="tb-my2sql" data-toggle="table" class="table table-condensed"
                           style="table-layout:inherit;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></table>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block js %}
    {% load static %}
    <link href="{% static 'datetimepicker/css/bootstrap-datetimepicker.css' %}" rel="stylesheet" type="text/css"/>
    <script src="{% static 'daterangepicker/js/moment.min.js' %}"></script>
    <script src="{% static 'datetimepicker/js/bootstrap-datetimepicker.js' %}"></script>
    <script src="{% static 'datetimepicker/js/bootstrap-datetimepicker.zh-CN.js' %}"></script>
    <script src="{% static 'bootstrap-table/js/bootstrap-table-export.min.js' %}"></script>
    <script src="{% static 'bootstrap-table/js/tableExport.min.js' %}"></script>
    <script>
        // Get current locale for bootstrap-table
        var currentLocale = '{% if LANGUAGE_CODE == "zh-hans" %}zh-CN{% elif LANGUAGE_CODE == "es" %}es-ES{% else %}en-US{% endif %}';

        $(".form_datetime").datetimepicker({format: 'yyyy-mm-dd hh:ii:ss', language: 'zh-CN', autoclose: true});

        //getUserInstancelist
        $(function () {
            $.ajax({
                type: "get",
                url: "/group/user_all_instances/",
                dataType: "json",
                data: {
                    db_type: ['mysql']
                },
                complete: function () {
                },
                success: function (data) {
                    if (data.status === 0) {
                        let result = data['data'];
                        $("#instance_name").empty();
                        for (let i = 0; i < result.length; i++) {
                            let instance = "<option value=\"" + result[i]['instance_name'] + "\">" + result[i]['instance_name'] + "</option>";
                            $("#instance_name").append(instance);
                        }
                        $('#instance_name').selectpicker('render');
                        $('#instance_name').selectpicker('refresh');
                    } else {
                        alert(data.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        });

        
        $("#instance_name").change(function () {
            //getdb_name
            $.ajax({
                type: "get",
                url: "/instance/instance_resource/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val(),
                    resource_type: "database"
                },
                complete: function () {
                },
                success: function (data) {
                    if (data.status === 0) {
                        var result = data.data;
                        $("#only_schemas").empty();
                        for (var i = 0; i < result.length; i++) {
                            var name = "<option value=\"" + result[i] + "\">" + result[i] + "</option>";
                            $("#only_schemas").append(name);
                        }
                        $('#only_schemas').selectpicker('render');
                        $('#only_schemas').selectpicker('refresh');
                    } else {
                        alert(data.msg);
                    }
                }
            });
            //getbinlog
            $.ajax({
                type: "post",
                url: "/binlog/list/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val()
                },
                complete: function () {
                },
                success: function (data) {
                    if (data.status === 0) {
                        var result = data.data;
                        $("#start_file").empty();
                        $("#end_file").empty();
                        for (var i = 0; i < result.length; i++) {
                            var name = "<option value=\"" + result[i]['Log_name'] + "\">" + result[i]['Log_name'] + '   Size:' + result[i]['File_size'] + "</option>";
                            $("#start_file").append(name);
                            $("#end_file").append(name);
                        }
                        $('#start_file').selectpicker('render');
                        $('#start_file').selectpicker('refresh');
                        $('#end_file').selectpicker('render');
                        $('#end_file').selectpicker('refresh');
                    } else {
                        alert(data.msg);
                    }
                }
            });
        });

        //Reset start-pos when start-file changes
        $("#start_file").change(function () {
            $("#start_pos").val('');
        });

        //Reset end-pos when end-file changes
        $("#end_file").change(function () {
            $("#end_pos").val('');
        });

        //Get table names when database changes
        $("#only_schemas").change(function () {
            
            $.ajax({
                type: "get",
                url: "/instance/instance_resource/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val(),
                    db_name: $("#only_schemas").val(),
                    resource_type: "table"
                },
                complete: function () {
                },
                success: function (data) {
                    if (data.status === 0) {
                        var result = data.data;
                        $("#only_tables").empty();
                        for (var i = 0; i < result.length; i++) {
                            var name = "<option>" + result[i] + "</option>";
                            $("#only_tables").append(name);
                        }
                        $("#only_tables").prepend("<option value=\"is-empty\" disabled=\"\">" + gettext("Table filter (optional):") + "</option>");
                        $('#only_tables').selectpicker('render');
                        $('#only_tables').selectpicker('refresh');
                    } else {
                        alert(data.msg);
                    }
                }
            });
        });

        //Get SQL statements
        $("#my2sql").click(function () {
            if ($("#instance_name").val() && $("#start_file").val()) {
                if (!$("#end_file").val()) {
                    $("#end_file").val($("#start_file").val());
                    $('#end_file').selectpicker('render');
                }
                if (!$("#end_pos").val()) {
                    let default_end_pos = $("#end_file option:selected").text().split('Size:')[1];
                    $("#end_pos").val(default_end_pos);
                }
                $(this).addClass('disabled');
                $(this).prop('disabled', true);
                $.ajax({
                    type: "post",
                    url: "/binlog/my2sql/",
                    dataType: "json",
                    data: {
                        instance_name: $("#instance_name").val(),
                        save_sql: document.getElementById("save_sql").checked,
                        rollback: document.getElementById("rollback").checked,
                        extra_info: document.getElementById("extra_info").checked,
                        ignore_primary_key: document.getElementById("ignore_primary_key").checked,
                        full_columns: document.getElementById("full_columns").checked,
                        no_db_prefix: document.getElementById("no_db_prefix").checked,
                        file_per_table: document.getElementById("file_per_table").checked,

                        threads: $("#threads").val(),
                        num: $("#num").val(),
                        start_file: $("#start_file").val(),
                        start_pos: $("#start_pos").val(),
                        end_file: $("#end_file").val(),
                        end_pos: $("#end_pos").val(),
                        stop_time: $("#stop_time").val(),
                        start_time: $("#start_time").val(),
                        only_schemas: $("#only_schemas").val(),
                        only_tables: $("#only_tables").val(),

                        sql_type: $("#sql_type").val(),
                    },
                    complete: function () {
                        $("#my2sql").removeClass('disabled');
                        $("#my2sql").prop('disabled', false);
                    },
                    success: function (data) {
                        if (data.status === 0) {
                            $('#tb-my2sql').bootstrapTable('destroy').bootstrapTable({
                                escape: true,
                                striped: true,                      //Show row stripes
                                cache: false,                       //Use cache，Default istrue，so usually need to set this property（*）
                                pagination: true,                   //Show pagination（*）
                                sortable: true,                     //Enable sorting
                                sidePagination: "client",           //Pagination mode：clientClient-side pagination，serverServer-side pagination（*）
                                pageNumber: 1,                      //Initialize load first page，Default first page,and record
                                pageSize: 100,                       //Records per page（*）
                                pageList: [100, 500, 1000],   //Selectable rows per page（*）
                                search: false,                       //Show table search
                                strictSearch: false,                //Exact match search
                                showColumns: true,                  //Show all columns（Select columns to display）
                                showRefresh: false,                  //Show refresh button
                                showExport: true,
                                exportDataType: "all",
                                minimumCountColumns: 1,             //Minimum columns allowed
                                clickToSelect: false,                //Enable click to select row
                                uniqueId: "id",                     //Unique identifier for each row，Usually primary key column
                                showToggle: true,                   //Show toggle button for detail/list view
                                cardView: false,                    //Show detail view
                                locale: currentLocale,                    //Localization
                                detailView: true,                   //Show parent-child table
                                
                                detailFormatter: function (index, row) {
                                    var html = [];
                                    $.each(row, function (key, value) {
                                        if (key === 'sql') {
                                            var sql = window.sqlFormatter.format(value);
                                            
                                            sql = sql.replace(/\r\n/g, "<br>");
                                            sql = sql.replace(/\n/g, "<br>");
                                            
                                            sql = sql.replace(/\s/g, "&nbsp;");
                                            html.push('<span>' + sql + '</span>');
                                        }
                                    });
                                    return html.join('');
                                },
                                data: data.data,
                                columns: [{



                                    title: 'SQL',
                                    field: 'sql',
                                    formatter: function (value, row, index) {
                                        if (value.length > 200) {
                                            var sql = row.sql.substr(0, 150) + '...';
                                            return sql;
                                        } else {
                                            return value
                                        }
                                    }
                                }, {
                                    title: gettext('Full SQL'),
                                    field: 'sql',
                                    visible: false 
                                }],
                                onLoadSuccess: function () {
                                    
                                },
                                onLoadError: onLoadErrorCallback,
                            });
                        } else {
                            alert(data.msg);
                        }
                    }
                });
            } else {
                alert(gettext("Please select instance and start parse file!"))
            }

        })

    </script>
{% endblock %}
