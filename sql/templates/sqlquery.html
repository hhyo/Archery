{% extends "base.html" %}
{% load i18n %}

{% block content %}
    <!-- Modal -->
    <div class="modal fade" id="favorite">
        <div class="modal-dialog modal-sm">
            <div class="modal-content message_align">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">×</span></button>
                    <h4 class="modal-title text-danger">{% trans "Favorite Statement" %}</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="query_log_id">
                    <input id="alias" name="alias" type='text' autocomplete="off" class="form-control"
                           placeholder="{% trans 'Enter statement alias' %}"/>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" id="btn-star" class="btn btn-danger" onclick="star()">{% trans "Star" %}</button>
                </div>
            </div>
        </div>
    </div>
    <div class="row clearfix">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading form-inline">{% trans "SQL Query" %}<select id="favorites" name="favorites"
                            class="form-control selectpicker"
                            data-live-search="true" data-live-search-placeholder="{% trans 'Search' %}"
                            title="{% trans 'Favorite Queries' %}"
                            required>
                        {% for sql in favorites %}
                            <option value={{ sql.id }}>{{ sql.alias }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-group ">
                        {% if storage_type %}
                            {% if can_offline_download == 1 %}
                                <button id="btn-exportsubmit" type="button" class="btn btn-default">
                                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>{% trans "Submit Export Ticket" %}</button>
                            {% endif %}
                        {% endif %}
                    </div>
                    <textarea id="generateDesc" class="form-control" style="display: none;width: 70%;" placeholder="AI Query Description" rows=1></textarea>
                    <input id="btn-generatesql" type="button" class="btn btn-info" style="display: none" value="Generate SQL"/>
                    <button id="btn-openaiTooltip" type="button" class="btn" style="display: none" data-toggle="tooltip" title="Only this action will interact with AI interact, collect database type、table structure and input info, give to AI Generate SQL and place in the SQL box below" >
                        <span class="fa fa-question-circle" />
                    </button>
                </div>
                <div class="panel-body">
                    <form id="form-sqlquery" action="/sqlquery/" method="post" class="form-horizontal" role="form">
                        {% csrf_token %}
                        <div class="col-md-9 column">
                            <pre id="sql_content_editor" class="ace_editor " style="min-height:350px"></pre>
                        </div>
                        <div class="col-md-3 column">
                            <div class="form-group">
                                <select id="instance_name" name="instance_name"
                                        class="selectpicker show-tick form-control bs-select-hidden"
                                        data-live-search="true" data-live-search-placeholder="{% trans 'Search instances in your group' %}"
                                        title="{% trans 'Select Instance:' %}"
                                        data-placeholder="{% trans 'Select Instance:' %}" required>
                                {% for name,engine in engines.items %}
                                    <optgroup id="optgroup-{{ name }}" label="{{ engine.name }}"></optgroup>
                                {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="db_name" name="db_name"
                                        class="form-control selectpicker show-tick bs-select-hidden"
                                        data-live-search="true" data-live-search-placeholder="{% trans 'Search database to query' %}"
                                        title="{% trans 'Select Database:' %}"
                                        data-placeholder="{% trans 'Select Database:' %}" required>
                                </select>
                            </div>
                            <div id="div-schema_name" class="form-group" style="display: none">
                                <select id="schema_name" name="schema_name"
                                        class="form-control selectpicker show-tick bs-select-hidden"
                                        data-live-search="true"
                                        title="{% trans 'Select Schema:' %}"
                                        data-placeholder="{% trans 'Select Schema:' %}" required>
                                </select>
                            </div>
                            <div id="div-table_name" class="form-group">
                                <select id="table_name" name="table_name"
                                        class="form-control selectpicker show-tick bs-select-hidden"
                                        data-live-search="true" data-live-search-placeholder="{% trans 'Search table to query' %}"
                                        data-name="View Table Structure"
                                        title="{% trans 'View Table Structure:' %}"
                                        data-placeholder="{% trans 'View Table Structure:' %}" required>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="limit_num" name="limit_num"
                                        class="form-control selectpicker show-tick bs-select-hidden"
                                        data-placeholder="{% trans 'Row Limit:' %}" required>
                                    <option value="is-empty" disabled="">{% trans "Row Limit:" %}</option>
                                    <option value=100 selected="selected">100</option>
                                    <option value=500>500</option>
                                    <option value=1000>1000</option>
                                    <option value=0>{% trans "max (Max Row Limit)" %}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input id="btn-format" type="button" class="btn btn-info" value="{% trans 'Format' %}"/>
                                <input id="btn-explain" type="button" class="btn btn-warning" value="{% trans 'Explain' %}"/>
                                <input id="btn-sqlquery" type="button" class="btn btn-success" value="{% trans 'SQL Query' %}"/>
                            </div>
                        </div>
                        <div class="text-info">
                            <li>{% trans "Supports comment lines. You can select specific statements to execute. Executes first statement by default." %}</li>
                            <li>{% trans "Query result row limit depends on permission settings. Will use the minimum limit of involved tables." %}</li>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-12 column">
            <div class="panel panel-default">
                <div class="panel-heading">{% trans "Query Results" %}<span style="color: red">
                        <small id="seconds_behind_master"></small>
                    </span>
                </div>
                <div class="panel-body">
                    <!-- Nav tabs -->
                    <ul id="nav-tabs" class="nav nav-tabs" role="tablist">
                        <li class="active" id="sqllog_tab">
                            <a href="#sql_log_result" role="tab" data-toggle="tab">{% trans "Query History" %}</a>
                        </li>
                        <button class="btn btn-default btn-sm pull-right" onclick="tab_remove()">
                            <span class="glyphicon glyphicon-minus"></span>
                        </button>
                        <button class="btn btn-default btn-sm pull-right" onclick="tab_add()">
                            <span class="glyphicon glyphicon-plus"></span>
                        </button>
                    </ul>
                    <!-- Tab panes -->
                    <div id="tab-content" class="form-group tab-content">
                        <div id="redis_help" role="tabpanel"
                             class="form-group tab-pane fade in table-responsive">
                            <div class="col-sm-12">
                                <div class="radio i-checks">
                                    <label> <input type="radio" value="key" name="operate" checked
                                                   onclick="show(this)"> <i> {% trans "Key Operations" %} </i></label>
                                    <label> <input type="radio" value="string" name="operate"
                                                   onclick="show(this)"> <i> String </i></label>
                                    <label> <input type="radio" value="hash" name="operate"
                                                   onclick="show(this)"> <i> Hash </i></label>
                                    <label> <input type="radio" value="set" name="operate"
                                                   onclick="show(this)"> <i> Set </i></label>
                                    <label> <input type="radio" value="zset" name="operate"
                                                   onclick="show(this)"> <i> Zset </i></label>
                                </div>

                                <div id="keyHelp" class="alert alert-info" style="display: block">
                                    <i> 1. exists key - Check if key exists. Returns 1 if exists, 0 otherwise</i></br>
                                    <i> 2. keys pattern - Find all keys matching pattern</i></br>
                                    <i> 3. expire key seconds - Set key timeout (unit: seconds). When expired, key will be automatically deleted</i></br>
                                    <i> 4. ttl key - Returns remaining TTL in seconds. Returns -2 if key not exists, -1 if no TTL set</i></br>
                                    <i> 5. pttl key - Similar to ttl, returns remaining TTL in milliseconds</i></br>
                                    <i> 6. move key db - Move key to specified database</i></br>
                                    <i> 7. type key - Returns value type: none, string, list, set, zset, hash</i>
                                </div>

                                <div id="stringHelp" class="alert alert-info" style="display: none">
                                    <i> 1. get key - Returns key value. Returns nil if not exists, error if not string type</i></br>
                                    <i> 2. mget key [key...] - Returns multiple key values. Returns nil for non-existent keys</i></br>
                                    <i> 3. strlen key - Returns string length. Returns 0 if not exists, error if not string</i></br>
                                    <i> 4. append key value - Append value to key. Creates key if not exists. Returns length after append</i></br>
                                    <i> 5. set key value [ex seconds] [px milliseconds] [nx|xx] - Set key value. ex/px set expiration, nx only if not exists, xx only if exists</i></br>
                                    <i> 6. setex key seconds value - Set key with TTL in seconds</i></br>
                                    <i> 7. setnx key value - Set key only if not exists</i></br>
                                    <i> 8. mset key value [key value...] - Set multiple keys atomically. All succeed or all fail</i></br>
                                    <i> 9. msetnx key value [key value...] - Like mset but all keys must not exist. If one exists, all fail</i>
                                </div>

                                <div id="hashHelp" class="alert alert-info" style="display: none">
                                    <i> 1. hgetall key - Get all fields and values from hash</i></br>
                                    <i> 2. hexists key field - Check if field exists in hash. Returns 1 if exists, 0 otherwise</i></br>
                                    <i> 3. hget key field - Get field value from hash. Returns nil if not exists</i></br>
                                    <i> 4. hmget key field[field...] - Get multiple field values. Returns empty if key not exists, nil for missing fields</i></br>
                                    <i> 5. hkeys key - Returns all fields in hash. Returns empty if key not exists</i></br>
                                    <i> 6. hvals key - Returns all values in hash. Returns empty if key not exists</i></br>
                                    <i> 7. hdel key field[field...] - Delete fields from hash. Ignores non-existent fields</i></br>
                                    <i> 8. hset key field value - Set field value. Creates hash if not exists, overwrites if field exists</i></br>
                                    <i> 9. hsetnx key field value - Set field only if not exists. Returns 0 if field exists</i>
                                </div>

                                <div id="setHelp" class="alert alert-info" style="display: none">
                                    <i> 1. smembers key - List all members of set</i></br>
                                    <i> 2. scard key - Returns number of elements in set</i></br>
                                    <i> 3. sdiff key[key...] - Get difference of sets. Returns all members if only one key</i></br>
                                    <i> 4. sunion key[key...] - Returns union of sets. Non-existent keys treated as empty</i></br>
                                    <i> 5. spop key - Remove and return random element. Returns NULL if key not exists</i></br>
                                    <i> 6. sismember key member - Check if member exists in set. Returns 0 or 1</i></br>
                                    <i> 7. sadd key member[member...] - Add members to set. Ignores existing members</i></br>
                                    <i> 8. smove source destination member - Move member between sets. Returns 0 if source/member not exists</i></br>
                                    <i> 9. srem key member[member] - Remove members from set. Ignores non-existent members</i>
                                </div>

                                <div id="zsetHelp" class="alert alert-info" style="display: none">
                                    <button class="close" data-dismiss="alert">
                                        <i class="ace-icon fa fa-times"></i>
                                    </button>
                                    <i class="ace-icon fa fa-hand-o-right"> {% trans "Help Documentation:" %}</i></br>
                                    <i> 1. zrange key start stop [WITHSCORES] - Return members in index range from sorted set</i></br>
                                    <i> 2. zrangebyscore key min max [WITHSCORES] [LIMIT] - Return members in score range</i></br>
                                    <i> 3. zscore key member - Return score of member in sorted set</i></br>
                                    <i> 4. zcard key - Get member count of sorted set</i></br>
                                    <i> 5. zcount key min max - Count members in score range</i></br>
                                    <i> 6. zrank key member - Return index of member in sorted set</i></br>
                                </div>
                            </div>
                        </div>
                        <div id="sql_log_result" role="tabpanel"
                             class="form-group tab-pane fade in active table-responsive">
                            <table id="sql-log" data-toggle="table" class="form-group table table-condensed"
                                   style="table-layout:inherit;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block js %}
    {% load static %}
    <script src="{% static 'ace/ace.js' %}"></script>
    <script src="{% static 'ace/ext-language_tools.js' %}"></script>
    <script src="{% static 'ace/mode-mysql.js' %}"></script>
    <script src="{% static 'ace/theme-github.js' %}"></script>
    <script src="{% static 'ace/snippets/mysql.js' %}"></script>
    <script src="{% static 'ace/ace-init.js' %}"></script>
    <script src="{% static 'bootstrap-table/export-libs/FileSaver/FileSaver.min.js' %}"></script>
    <script src="{% static 'bootstrap-table/export-libs/js-xlsx/xlsx.core.min.js' %}"></script>
    <script src="{% static 'bootstrap-table/js/bootstrap-table-export.min.js' %}"></script>
    <script src="{% static 'bootstrap-table/js/tableExport.min.js' %}"></script>

    <!-- Query history -->
    <script>
        // Get current locale for bootstrap-table
        var currentLocale = '{% if LANGUAGE_CODE == "zh-hans" %}zh-CN{% elif LANGUAGE_CODE == "es" %}es-ES{% else %}en-US{% endif %}';

        //Get query list
        function get_querylog(query_log_id) {
            var showExport = {{can_download}}===1
            //Initializetable
            $('#sql-log').bootstrapTable('destroy').bootstrapTable({
                escape: true,
                method: 'get',
                contentType: "application/x-www-form-urlencoded",
                url: "/query/querylog/",
                striped: true,                      //Show row stripes
                cache: false,                       //Use cache，Default istrue，so usually need to set this property（*）
                pagination: true,                   //Show pagination（*）
                sortable: true,                     //Enable sorting
                sortOrder: "asc",                   //Sort order
                sidePagination: "server",           //Pagination mode：clientClient-side pagination，serverServer-side pagination（*）
                pageNumber: 1,                      //Initialize load first page，Default first page,and record
                pageSize: 20,                       //Records per page（*）
                pageList: [10, 30, 50, 100],        //Selectable rows per page（*）
                showExport: showExport,                   //Show export button
                exportTypes: ['json', 'sql', 'csv', 'txt', 'xml', 'xlsx'],
                exportOptions: {
                    ignoreColumn: [0],  
                    fileName: 'query_log'  //File name setting
                },
                search: true,                       //Show table search
                strictSearch: false,                //Exact match search
                showColumns: true,                  //Show all columns（Select columns to display）
                showRefresh: true,                  //Show refresh button
                minimumCountColumns: 2,             //Minimum columns allowed
                clickToSelect: true,                //Enable click to select row
                uniqueId: "id",                     //Unique identifier for each row，Usually primary key column
                showToggle: true,                   //Show toggle button for detail/list view
                cardView: false,                    //Show detail view
                detailView: true,                   //Show parent-child table
                locale: currentLocale,                    //Localization
                toolbar: "#query-log-toolbar",      //Specify customtoolbar
                queryParamsType: 'limit',
                //Get query list parameters when requesting data
                queryParams:
                    function (params) {
                        return {
                            star: $("#filter-star").val(),
                            query_log_id: $("#filter-alias").val(),
                            limit: params.limit,
                            offset: params.offset,
                            search: params.search
                        }
                    },
                
                detailFormatter: function (index, row) {
                    var html = [];
                    $.each(row, function (key, value) {
                        if (key === 'sqllog') {
                            let sql = value;
                            
                            sql = sql.replace(/&/g, "&amp;");
                            sql = sql.replace(/</g, "&lt;");
                            sql = sql.replace(/>/g, "&gt;");
                            sql = sql.replace(/"/g, "&quot;");
                            
                            sql = sql.replace(/\r\n/g, "<br>");
                            sql = sql.replace(/\n/g, "<br>");
                            
                            sql = sql.replace(/\s/g, "&nbsp;");
                            html.push('<span>' + sql + '</span>');
                        }
                    });
                    return html.join('');
                },
                columns: [{
                    title: 'Operations',
                    field: '',
                    formatter: function (value, row, index) {
                        if (row.favorite) {
                            var btn_favorite = "<button type=\"button\" class=\"btn btn-xs\" data-toggle=\"tooltip\" title=\"" + gettext("Remove Favorite") + "\" onclick=\"unstar(" + row.id + ")" + "\"><span class=\"fa fa-star\"></span></button>\n";
                        } else {
                            var btn_favorite = "<button type=\"button\" class=\"btn btn-xs\" data-toggle=\"modal\" data-target=\"#favorite\" onclick=\"star(" + row.id + ")" + "\"><span class=\"fa fa-star-o\"></span></button>\n";
                        }
                        let btn_re_query = "<button type=\"button\" class=\"btn btn-xs\"  data-toggle=\"tooltip\" title=\"" + gettext("Quick Query") + "\" onclick=\"re_query(" + row.id + ")" + "\"><span class=\"fa fa-search\"></span></button>";
                        return btn_favorite + btn_re_query
                    }

                }, {
                    title: 'User',
                    field: 'user_display'
                }, {
                    title: 'Instance',
                    field: 'instance_name'
                }, {
                    title: 'Database',
                    field: 'db_name'
                }, {
                    title: gettext('Query Time'),
                    field: 'create_time'
                }, {
                    title: gettext('Statement'),
                    field: 'sqllog',
                    formatter: function (value, row, index) {
                        var _sql=row.sqllog
                        if (_sql.length > 50) {
                            var sql = _sql.substr(0, 50) + '...';
                            return sql;
                        } else {
                            return value
                        }
                    }
                }, {
                    title: gettext('Full Statement'),
                    field: 'sqllog',
                    visible: false
                }, {
                    title: gettext('Rows Returned'),
                    field: 'effect_row'
                }, {
                    title: gettext('Duration (sec)'),
                    field: 'cost_time'
                }],
                onLoadSuccess: function () {
                    if (query_log_id) {
                        re_query(query_log_id)
                    }
                },
                onLoadError: onLoadErrorCallback,
                onSearch: function (e) {
                    //Pass search params to server
                    queryParams(e)
                },
                responseHandler: function (res) {
                    
                    return res;
                }
            });
        }

        
        $("#filter-star").change(function () {
            get_querylog();
        });
        $("#filter-alias").change(function () {
            get_querylog()
        });

        
        $("#favorites").change(function () {
            let query_log_id = $("#favorites").val();
            $("#filter-alias").val(query_log_id);
            $('#filter-alias').selectpicker('render');
            $('#filter-alias').selectpicker('refresh');
            get_querylog(query_log_id);
        });

        
        function star(query_log_id) {
            if (query_log_id) {
                $("#query_log_id").val(query_log_id);
            } else if ($("#alias").val()) {
                $.ajax({
                    type: "post",
                    url: "/query/favorite/",
                    dataType: "json",
                    data: {
                        query_log_id: $("#query_log_id").val(),
                        star: true,
                        alias: $("#alias").val(),
                    },
                    complete: function () {
                        $("#sql-log").bootstrapTable('refresh');
                        $("#favorite").modal('hide');
                        $("#alias").val('')
                    },
                    success: function (data) {
                        if (data.status !== 0) {
                            alert(data.msg);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(errorThrown);
                    }
                });
            } else {
                alert(gettext('Please enter statement alias!'))
            }
        }

        // Remove favorite
        function unstar(query_log_id) {
            $.ajax({
                type: "post",
                url: "/query/favorite/",
                dataType: "json",
                data: {
                    query_log_id: query_log_id,
                    star: false,
                    alias: '',
                },
                complete: function () {
                    $("#sql-log").bootstrapTable('refresh');
                },
                success: function (data) {
                    if (data.status !== 0) {
                        alert(data.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        }

        
        function re_query(query_log_id) {
            sessionStorage.setItem('re_query', 'true');
            let row_data = $('#sql-log').bootstrapTable('getRowByUniqueId', query_log_id);
            $("#instance_name").selectpicker('val', row_data['instance_name']);
            if ($("#instance_name").val()) {
                $("#instance_name").selectpicker().trigger("change");
            }
            $("#db_name").selectpicker('val', row_data['db_name']);
            let instance_name = $("#instance_name").val();
            let db_name = $("#db_name").val();
            if (db_name) {
                $("#db_name").selectpicker().trigger("change");
            }
            let sql = row_data['sqllog'];
            let limit_num = $("#limit_num").val();
            editor.setValue(sql);
            editor.clearSelection();
            $("#limit_num").val(limit_num);
            if (instance_name && db_name && sql) {
                $('input[type=button]').addClass('disabled');
                $('input[type=button]').prop('disabled', true);
                sqlquery()
            } else {
                alert(gettext("Incomplete information, cannot perform quick query!"))
            }
            sessionStorage.removeItem('re_query');
        }

        // Get system config
        function check_openai() {
            $.ajax({
                type: "get",
                url: "/check/openai/",
                dataType: "json",
                data: false,
                complete: function () {
                },
                success: function (data) {
                    if (data["data"]) {
                        $("#generateDesc").show()
                        $("#btn-generatesql").show()
                        $("#btn-openaiTooltip").show()
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        }
    </script>
    <!-- Execute Result -->
    <script>
        
        function redis_help_tab_add() {
            redis_help_tab_remove();
            
            var li = document.createElement("li"); 
            li.setAttribute("id", "redis_help_tab");
            li.setAttribute("role", "presentation");

            var href_a = document.createElement("a"); 
            href_a.setAttribute("href", "#redis_help");
            href_a.setAttribute("role", "tab");
            href_a.setAttribute("data-toggle", "tab");
            href_a.innerHTML = gettext("Redis Help Documentation");
            li.appendChild(href_a);

            $("#nav-tabs").prepend(li); //Add li to ul
            $("#nav-tabs a:first").tab('show')
        }

        // Delete Redis help tab
        function redis_help_tab_remove() {
            $("#redis_help_tab").remove();
            
            $("#nav-tabs a:last").tab('show');
        }

        
        function tab_add(tab_title) {
            var tab_number = sessionStorage.getItem('tab_num');

            
            var li = document.createElement("li"); 
            li.setAttribute("id", "execute_result_tab" + (Number(tab_number) + 1));
            li.setAttribute("role", "presentation");

            var href_a = document.createElement("a"); 
            href_a.setAttribute("href", "#sqlquery_result" + (Number(tab_number) + 1));
            href_a.setAttribute("role", "tab");
            href_a.setAttribute("data-toggle", "tab");
            if (tab_title) {
                href_a.innerHTML = tab_title;
            } else {
                href_a.innerHTML = gettext("Execute Result") + (Number(tab_number) + 1);

            }
            li.appendChild(href_a);

            
            var cache_sql = document.createElement("input");
            cache_sql.setAttribute("type", "hidden")
            cache_sql.setAttribute("sql_cache", editor.getValue())
            li.appendChild(cache_sql);

            $("#nav-tabs").append(li); //Add li to ul

            //Execute Result tab count +1
            sessionStorage.setItem('tab_num', Number(tab_number) + 1);
            
            tab_number = sessionStorage.getItem('tab_num');

            
            var div =
                "<div id=\"sqlquery_result" + tab_number + "\" role=\"tabpanel\" class=\"tab-pane fade table-responsive\">\n" +
                "    <div id=\"query_time" + tab_number + "\" class=\"navbar-text\" >\n" +
                "        <small>" + gettext("Query Time") + " : <strong id=\"time" + tab_number + "\"> sec </strong></small>\n" +
                "    </div>\n" +
                "    <div id=\"mask_time" + tab_number + "\" class=\"navbar-text\" >\n" +
                "        <small>" + gettext("Masking Time") + " : <strong id=\"masking_time" + tab_number + "\"> sec </strong></small>\n" +
                "    </div>\n" +
                "    <table id=\"query_result" + tab_number + "\" data-toggle=\"table\" class=\"table table-condensed\"\n" +
                "           style=\"table-layout:inherit;white-space:pre;overflow:hidden;text-overflow:ellipsis;\"></table>\n" +
                "</div>\t";
            $("#tab-content").append(div); //Add div to div

            
            $("#nav-tabs a:last").tab('show')

        }

        //Delete Execute Result page
        function tab_remove() {
            var tab_number = sessionStorage.getItem('tab_num');
            var active_li_id = sessionStorage.getItem('active_li_id');

            if (active_li_id === 'sqllog_tab') {
                //alert("Query history tab cannot be deleted")
            }
            
            else if (active_li_id.match(/^execute_result_tab*/)) {
                //Only execute when sqlquery_result tab count > 0
                if (Number(tab_number) > 0) {
                    var n = active_li_id.split("execute_result_tab")[1];
                    $("#" + active_li_id).remove();
                    $("#" + 'sqlquery_result' + n).remove();

                    
                    $("#nav-tabs a:last").tab('show');
                    sessionStorage.setItem('tab_num', Number(tab_number) - 1);
                    
                }
            }
        }

        
        function sqlquery_validate() {
            var result = true;
            var instance_name = $("#instance_name").val();
            var db_name = $("#db_name").val();
            var sqlContent = editor.getValue();
            var select_sqlContent = editor.session.getTextRange(editor.getSelectionRange());
            if (select_sqlContent) {
                sqlContent = select_sqlContent
            }
            if (!instance_name) {
                alert(gettext("Please select an instance!"));
                return result = false;
            } else if (!db_name) {
                alert(gettext("Please select a database!"));
                return result = false;
            } else if (!sqlContent) {
                alert(gettext("SQL content cannot be empty!"));
                return result = false;
            }
            return result;
        }

        
        $("#btn-generatesql").click(function () {
                var check = false
                var optgroup = $('#instance_name :selected').parent().attr('label')
                var instance_name = $("#instance_name").val()
                var db_name = $("#db_name").val()
                var tb_name = $("#table_name").val()
                var query_desc = $("#generateDesc").val()

                if (!instance_name) {
                    alert(gettext("Please select an instance!"))
                } else if (!db_name) {
                    alert(gettext("Please select a database!"))
                } else if (optgroup !== 'Redis' && !tb_name){
                    alert(gettext("Please select a table structure!"))
                } else if (!query_desc) {
                    alert(gettext("Please enter query description!"))
                } else {
                    check = true
                }
                if (check) {
                    generatesql()
                }
            }
        );

        
        $("#btn-sqlquery").click(function () {
                dosqlquery();
            }
        );

        const exportButton = document.getElementById('btn-exportsubmit');
        if (exportButton) {
            exportButton.addEventListener('click', function() {
                    var sqlContent = editor.getValue();
                    var select_sqlContent = editor.session.getTextRange(editor.getSelectionRange());
                    if (select_sqlContent) {
                        sqlContent = select_sqlContent
                    }
                    group_name = $("#group_name").val()
                    instance_name = $("#instance_name").val()
                    db_name = $("#db_name").val()
                    sessionStorage.setItem('submitSqlContent', sqlContent);
                    window.open('/sqlexportsubmit/?source=query', '_blank');
                }
            );
        }

        
        
        $("#btn-explain").click(function () {
                if (sqlquery_validate()) {
                    const inputButton = $('input[type=button]')
                    inputButton.addClass('disabled');
                    inputButton.prop("disabled", true)
                    sqlquery('explain')
                }
            }
        );

        
        $("#btn-format").click(function () {
                var select_sqlContent = editor.session.getTextRange(editor.getSelectionRange());
                var optgroup = $('#instance_name :selected').parent().attr('label');
                let sqlContent = '';
                if (select_sqlContent) {
                    sqlContent = select_sqlContent
                } else {
                    sqlContent = editor.getValue();
                }
                sqlContent = window.sqlFormatter.format(sqlContent);
                editor.setValue(sqlContent);
                editor.clearSelection();
            }
        );

        
        editor.session.on('change', function (delta) {
            var sqlContent = editor.getValue();
            window.sessionStorage.setItem('sqlContent', sqlContent);
            //Get current tab
            var active_li_id = sessionStorage.getItem('active_li_id');
            var active_li_title = sessionStorage.getItem('active_li_title');
            if (active_li_title.match(/^Execute Result\d$/)){
                //Currently active Execute Result page
                var n = active_li_id.split("execute_result_tab")[1];
                
              var inputs = $("#execute_result_tab"+n + " input");
              if(inputs.length > 0){
                    inputs[0].setAttribute("sql_cache", sqlContent)
                }
            }

        });

        function highLight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'text-muted';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'text-success';
                    } else {
                        match = match
                        cls = 'text-primary';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'text-success';
                } else if (/null/.test(match)) {
                    cls = 'text-warning';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        
        function display_data(data, target='') {
            var result = data.data;
            var query_str = target+'|'+result['full_sql'];
            //Get current tab. If not on Execute Result page, create a new page by default
            var active_li_id = sessionStorage.getItem('active_li_id');
            let active_li_title = sessionStorage.getItem('active_li_title');
            let tb_name, n
            let need_describe_display = false
            if (data.status === 0) {
                // View Table Structure: add new tab by default, don't add if same table structure
                if (result['full_sql'].match(/^show\s+create\s+table\s+(.*)/)) {
                    need_describe_display = true
                    if (data.is_describe===undefined || !data.is_describe) {
                        tb_name = result['full_sql'].match(/^show\s+create\s+table\s+(.*);/)[1];
                    }
                }
                if (data.is_describe || need_describe_display) {
                    if (tb_name === undefined) {
                        tb_name = $("#table_name").val();
                    }
                    if (tb_name !== active_li_title) {
                        tab_add(tb_name);
                    }
                    n = sessionStorage.getItem('tab_num');
                    if (result.column_list === ["table", "create table"]) {
                        need_describe_display = true
                    }
                }
                // Execute Result page: don't add new tab by default
                else if (active_li_title.match(/^ExecuteResult\d$/)) {
                    n = active_li_id.split("execute_result_tab")[1];
                } else {
                    tab_add();
                    n = sessionStorage.getItem('tab_num');
                }
                
                for (let i=0; i<$("#execute_result_tab"+n+" p").length; i++) {
                    $("#execute_result_tab"+n+" p").remove();
                }
                $("#execute_result_tab"+n).append("<p style=\"display:none\">"+query_str+"</p>");

                
                if (result['column_list']) {
                    
                    let columns = [];
                    $.each(result['column_list'], function (i, column) {
                        var iswholeCol = true;
                        if (column == "mongodballdata") {
                            iswholeCol = false
                        }
                        columns.push({
                            "field": i,
                            "title": column,
                            "visible": iswholeCol,
                            "sortable": true,
                            cellStyle: function (value, row, index) {
                                if (!value && typeof (value) !== "undefined" && value !== 0) {
                                    return {
                                        css: {
                                            color: 'darkgrey'
                                        }
                                    }
                                } else {
                                    return {
                                        css: {}
                                    }
                                }
                            },
                            formatter: function (value, row, index, field) {
                                if (value instanceof Array || value instanceof Object){
                                    return JSON.stringify(value);
                                }
                                return value
                            }
                        });
                    });
                    if (need_describe_display) {
                        //Initialize table structure display
                        $(`#query_result${n}`).bootstrapTable('destroy').bootstrapTable({
                                escape: false,
                                data: result['rows'],
                                columns: [{
                                    title: 'Create Table',
                                    field: 1,
                                    formatter: function (value, row, index) {
                                        let sql = window.sqlFormatter.format(value);
                                        
                                        sql = sql.replace(/&/g, "&amp;");
                                        sql = sql.replace(/</g, "&lt;");
                                        sql = sql.replace(/>/g, "&gt;");
                                        sql = sql.replace(/"/g, "&quot;");
                                        
                                        sql = sql.replace(/\r\n/g, "<br>");
                                        sql = sql.replace(/\n/g, "<br>");
                                        
                                        return sql;
                                    },
                                }
                                ],
                                locale: currentLocale
                            }
                        );
                    } else {
                        //Initialize query result
                        var isdetail = false
                        var optgroup = $('#instance_name :selected').parent().attr('label');
                        if (optgroup === 'Mongo' || optgroup === 'Redis') {
                            isdetail = true
                        }
                        var showExport = {{can_download}}===1
                        var query_result_id=(`query_result${n}`);
                        $(`#${query_result_id}`).bootstrapTable('destroy').bootstrapTable({
                            escape: true,
                            data: result['rows'],
                            columns: columns,
                            showExport: showExport,
                            exportDataType: "all",
                            exportTypes: ['json', 'sql', 'csv', 'txt', 'xml', 'xlsx'],
                            exportOptions: {
                                //ignoreColumn: [0],
                                fileName: function () {
                                var userInput = prompt(gettext('Please enter filename:'));
                                return userInput || 'export_result';  // If user doesn't enter filename, use default
                                },
                                onFileSave: function (e) {
                                    var url = e.currentTarget.href;
                                    var xhr = new XMLHttpRequest();
                                    xhr.open('GET', url, true);
                                    xhr.responseType = 'blob';
                                    xhr.onload = function () {
                                        if (xhr.status === 200) {
                                            var blob = xhr.response;
                                            var downloadLink = document.createElement('a');
                                            downloadLink.href = window.URL.createObjectURL(blob);
                                            downloadLink.click();
                                        }
                                    };
                                    xhr.send();
                                    return false;
                                }
                            },
                            undefinedText: '(null)',
                            detailView: isdetail, 
                            showColumns: true,
                            showToggle: true,
                            clickToSelect: true,
                            striped: true,
                            pagination: true,
                            pageSize: 30,
                            pageList: [30, 50, 100, 500, 1000],
                            search: true,                      //Show table search
                            strictSearch: false,                //Exact match search
                            
                            detailFormatter: function (index, row) {
                                var html = [];
                                $.each(row, function (key, value) {
                                    if (key === 0) {//mongodb这里要修改
                                        let rs = value;
                                        if (optgroup === 'Redis') {
                                            try {
                                                rs = JSON.parse(rs);
                                                if (typeof rs == 'object' && rs) {
                                                    rs = JSON.stringify(rs, null, 2)
                                                }
                                            } catch (e) {
                                                html.push('<strong>' + gettext("Not JSON format, cannot format!") + '</strong>');
                                                return false;
                                            }
                                        }
                                        html.push('<pre>' + highLight(rs) + '</pre>');
                                    }
                                });
                                return html.join('');
                            },
                            onPostBody: function(data) {
                                
                                
                                var thHasDetail=$(`#${query_result_id} th.detail`);
                                thHasDetail.css('white-space', 'nowrap');
                                
                                var tdHasDetail=$(`#${query_result_id} tr[data-has-detail-view="true"] .detail-icon`).parent('td');
                                tdHasDetail.css('white-space', 'nowrap');
                            },
                            locale: currentLocale,
                            onExportSaved: function (e) {
                                var tabs = $("#nav-tabs li")
                                for(let i=0;i<tabs.length;i++){
                                    if(tabs[i].getAttribute("class") === "active") {
                                        // sqlContent固定隐藏绑定在第二个子元素
                                        var instance_name = $("#instance_name").val()
                                        var db_name =$("#db_name").val()
                                        var extraInfo = instance_name+"/"+db_name+"|"+$(tabs[i].children[1]).attr('sql_cache')+"|"+e.length;
                                        $.ajax({
                                            type: "post",
                                            url: "/audit/input/",
                                            dataType: "json",
                                            data: {
                                                action:"Download",
                                                extra_info: extraInfo
                                            },
                                            complete: function () {
                                                console.log("Callback triggered")
                                            },
                                            success: function (data) {
                                                console.log("Callback success")
                                                console.log(data)
                                            },
                                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                                console.log("Callback failed")
                                            }
                                        });
                                    }
                                }
                            },
                        });
                    }
                    //Set Execute Time and Masking Time values
                    $("#" + ('time') + n).text(result['query_time'] + ' sec');
                    $("#" + ('masking_time') + n).text(result['mask_time'] + ' sec');
                    
                    if (result['seconds_behind_master']) {
                        $("#seconds_behind_master").text('Seconds_Behind_Master:  ' + result['seconds_behind_master']);
                    }
                }

            } else {
                
                if (active_li_title.match(/^ExecuteResult\d$/)) {
                    n = active_li_id.split("execute_result_tab")[1];
                } else {
                    tab_add();
                    n = sessionStorage.getItem('tab_num');
                }
                $("#" + ('query_result' + n)).bootstrapTable('destroy').bootstrapTable({
                    escape: false,
                    columns: [{
                        field: 'error',
                        title: 'Error',
                        formatter: function (value, row, index) {
                            //staus为2的时候，增加Apply链接
                            if (data.status === 2) {
                                return value + "<a href=\"/queryapplylist/\">" + " (" + gettext("Submit Application") + ")" + "</a>"
                            } else {
                                return value
                            }
                        }
                    }],
                    data: [{
                        error: data.msg
                    }]
                })
            }
        }

        
        function sqlquery(sql) {
            var optgroup = $('#instance_name :selected').parent().attr('label');
            var select_sqlContent = editor.session.getTextRange(editor.getSelectionRange());
            if (select_sqlContent) {
                sqlContent = select_sqlContent
            } else {
                var sqlContent = editor.getValue();

            }
            if (optgroup === "Oracle") {
                //ViewExecute计划
                if (sql === 'explain') {
                    sqlContent = 'explain plan for ' + sqlContent
                }
                //View table structure
                else if (sql === 'show create table') {
                    sqlContent = "desc " + $("#table_name").val() + ";"
                }
            } else if (optgroup === "MySQL" || optgroup === "PgSQL" ) {
                //View execution plan
                if (sql === 'explain') {
                    sqlContent = 'explain ' + sqlContent
                }
                //View table structure
                else if (sql === 'show create table') {
                    sqlContent = "show create table " + $("#table_name").val() + ";"
                }
            } else if (optgroup === "Mongo") {
                //View execution plan
                if (sql === 'explain') {
                    sqlContent = 'explain ' + sqlContent
                }
            } else if (optgroup === "ClickHouse") {
                //View execution plan
                if (sql === 'explain') {
                    sqlContent = 'explain ' + sqlContent
                }
            } else if (optgroup === "Doris") {
                //View execution plan
                if (sql === 'explain') {
                    sqlContent = 'explain ' + sqlContent
                }
            }
            
            $.ajax({
                type: "post",
                url: "/query/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val(),
                    db_name: $("#db_name").val(),
                    schema_name: $("#schema_name").val(),
                    tb_name: $("#table_name").val(),
                    sql_content: sqlContent,
                    limit_num: $("#limit_num").val()
                },
                complete: function () {
                    $('input[type=button]').removeClass('disabled');
                    $('input[type=button]').prop('disabled', false);
                    optgroup_control();
                },
                success: function (data) {
                    var target = $("#instance_name").val()+"/"+$("#db_name").val();
                    display_data(data, target);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        }

        function generatesql() {
            var optgroup = $('#instance_name :selected').parent().attr('label');
            const data = {
                db_type: optgroup,
                instance_name: $("#instance_name").val(),
                db_name: $("#db_name").val(),
                schema_name: $("#schema_name").val(),
                tb_name: $("#table_name").val(),
                query_desc: $("#generateDesc").val(),
            }
            
            $.ajax({
                type: "post",
                url: "/query/generate_sql/",
                dataType: "json",
                data: data,
                complete: function () {
                    $('input[type=button]').removeClass('disabled');
                    $('input[type=button]').prop('disabled', false);
                    optgroup_control();
                },
                success: function (data) {
                    editor.setValue(data["data"]);
                    editor.clearSelection();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        }

        function dosqlquery() {
            if (sqlquery_validate()) {
                $('input[type=button]').addClass('disabled');
                $('input[type=button]').prop('disabled', true);
                sqlquery();
            }
        }
    </script>
    <!-- common -->
    <script>
        
        const defaultDisplayConfig = {
            showTableName: true,
            showSchemaName: false,
            showFormat: true,
            showExplain: true,
            showRedisHelp: false,
        }
        const createDisplayConfig = function(extraArgs = null) {
            if (extraArgs === null) {
                extraArgs = {}
            }
            return Object.assign({}, defaultDisplayConfig, extraArgs)
        }
        const engineDisplayConfig = {
            "MsSQL": createDisplayConfig({showExplain: false}),
            "Redis": createDisplayConfig({showTableName: true, showSchemaName: false,
                showRedisHelp: true,
                showFormat: false, showExplain: false}),
            "PgSQL": createDisplayConfig({showSchemaName: true}),
            "Mongo": createDisplayConfig({showFormat: false}),
            "Phoenix": createDisplayConfig({showExplain: false}),
            "Cassandra": createDisplayConfig({showExplain: false}),
            
            
        };
        
        function optgroup_control(change) {
            let optgroup = $('#instance_name :selected').parent().attr('label');
            let displayConfig = engineDisplayConfig[optgroup] || defaultDisplayConfig
            if (displayConfig.showExplain) {
                $("#btn-explain").attr('disabled', false);
            } else {
                $("#btn-explain").attr('disabled', true);
            }
            if (displayConfig.showFormat) {
                $("#btn-format").attr('disabled', false);
            } else {
                $("#btn-format").attr('disabled', true);
            }
            if (change) {
                if (displayConfig.showTableName) {
                    $("#div-table_name").show();
                } else {
                    $("#div-table_name").hide();
                }
                if (displayConfig.showSchemaName) {
                    $("#div-schema_name").show();
                } else {
                    $("#div-schema_name").hide();
                }
                if (displayConfig.showRedisHelp) {
                    redis_help_tab_add();
                } else {
                    redis_help_tab_remove();
                }
            }
        }

        
        $("#instance_name").change(function () {
            if (sessionStorage.getItem('re_query')) {
                get_instance(false)
            } else {
                get_instance(true)
            }
        });

        function get_instance(async) {
            optgroup_control(true);
            $("#db_name").empty();
            $('#db_name').selectpicker('render');
            $('#db_name').selectpicker('refresh');
            sessionStorage.setItem('sql_query_instance_name', $("#instance_name").val());
            //Get db_name
            $.ajax({
                type: "get",
                url: "/instance/instance_resource/",
                dataType: "json",
                async: async,
                data: {
                    instance_name: $("#instance_name").val(),
                    resource_type: "database"
                },
                complete: function () {
                    $("#db_name").selectpicker('val', db_name);
                    if ($("#db_name").val()) {
                        $("#db_name").selectpicker().trigger("change");
                    }
                },
                success: function (data) {
                    if (data.status === 0) {
                        var result = data.data;
                        var dbs = [];
                        for (var i = 0; i < result.length; i++) {
                            var name = "<option value=\"" + result[i] + "\">" + result[i] + "</option>";
                            $("#db_name").append(name);
                            dbs.push({
                                name: result[i],
                                value: result[i],
                                caption: result[i],
                                meta: 'databases',
                                score: '100'
                            })
                        }
                        $('#db_name').selectpicker('render');
                        $('#db_name').selectpicker('refresh');
                        
                        setCompleteData(dbs)
                    } else {
                        alert(data.msg);
                    }
                },

                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        }

        //Database change: get table/schema name
        $("#db_name").change(function () {
            $("#table_name").empty();
            $('#table_name').selectpicker('render');
            $('#table_name').selectpicker('refresh');
            $("#schema_name").empty();
            $('#schema_name').selectpicker('render');
            $('#schema_name').selectpicker('refresh');
            // PgSQL needs to select schema before getting tables
            var optgroup = $('#instance_name :selected').parent().attr('label');
            var resource_type = "table";
            if (optgroup === "PgSQL") {
                //Get schema
                resource_type = "schema"
            }
            $.ajax({
                type: "get",
                url: "/instance/instance_resource/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val(),
                    db_name: $("#db_name").val(),
                    resource_type: resource_type
                },
                complete: function () {
                    if (optgroup === "PgSQL") {
                        //Get schema
                        $("#div-schema_name").show();
                        $("#schema_name").selectpicker('val', db_name);
                        if ($("#schema_name").val()) {
                            $("#schema_name").selectpicker().trigger("change");
                        }
                    }
                },
                success: function (data) {
                    if (data.status === 0) {
                        var result = data.data;
                        if (resource_type === "table") {
                            if (optgroup == 'Mongo') {
                                $("#table_name").prepend("<option value=\"is-empty\" disabled=\"\" selected=\"selected\">" + gettext("View Collection:") + "</option>")
                            }
                            for (var i = 0; i < result.length; i++) {
                                var name = "<option>" + result[i] + "</option>";
                                $("#table_name").append(name);
                            }
                            $('#table_name').selectpicker('render');
                            $('#table_name').selectpicker('refresh');
                            
                            $("#schema_name").val('');
                            setTablesCompleteData(result)
                        } else {
                            for (var i = 0; i < result.length; i++) {
                                var name = "<option>" + result[i] + "</option>";
                                $("#schema_name").append(name);
                            }
                            $('#schema_name').selectpicker('render');
                            $('#schema_name').selectpicker('refresh');
                            
                            setSchemasCompleteData(result)
                        }

                    } else {
                        alert(data.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        });

        
        $("#schema_name").change(function () {
            $("#table_name").empty();
            $('#table_name').selectpicker('render');
            $('#table_name').selectpicker('refresh');
            //Get table
            $.ajax({
                type: "get",
                url: "/instance/instance_resource/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val(),
                    db_name: $("#db_name").val(),
                    schema_name: $("#schema_name").val(),
                    resource_type: "table"
                },
                complete: function () {
                    $("#schema_name").attr('disabled', false);
                },
                success: function (data) {
                    if (data.status === 0) {
                        var result = data.data;
                        for (var i = 0; i < result.length; i++) {
                            var name = "<option>" + result[i] + "</option>";
                            $("#table_name").append(name);
                        }
                        $('#table_name').selectpicker('render');
                        $('#table_name').selectpicker('refresh');
                        
                        setTablesCompleteData(result)
                    } else {
                        alert(data.msg);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        });

        //Get table structure
        $("#table_name").change(function () {
            $.ajax({
                type: "post",
                url: "/instance/describetable/",
                dataType: "json",
                data: {
                    instance_name: $("#instance_name").val(),
                    db_name: $("#db_name").val(),
                    schema_name: $("#schema_name").val(),
                    tb_name: $("#table_name").val()
                },
                success: function (data) {
                    data.is_describe = true;
                    var target = $("#instance_name").val()+"/"+$("#db_name").val();
                    display_data(data, target);
                },
            });
            
            setColumnsCompleteData()
        });


        
        $(function () {
            $("#nav-tabs").on('shown.bs.tab', "li", function (e) {
                //Currently active tab id
                sessionStorage.setItem('active_li_id', $(e.target).parents().attr('id'));
                //Currently active tab title
                sessionStorage.setItem('active_li_title', e.target.innerText);
                if ($(e.target).parents().attr('id') === 'sqllog_tab') {
                    get_querylog();
                }
                
                let li_sql = $(e.target).parent().children("input");
                if(li_sql.length>0){
                    var sql = li_sql[0].getAttribute('sql_cache');
                  if(sql && !editor.getValue()){
                        editor.setValue(sql);
                    }

                }

            });
        });

        //Initialize
        $(document).ready(function () {
            
            sessionStorage.setItem('tab_num', 0);
            
            sessionStorage.setItem('active_li_id', 'sqllog_tab');
            sessionStorage.setItem('active_li_title', 'Query History');

            
            let sqlContent = window.sessionStorage.getItem('sqlContent');
            if (sqlContent != null) {
                editor.setValue(sqlContent);
            } else {
                editor.setValue("");
            }
            
            // Check if OpenAI config exists to support AI query generation feature
            check_openai()

            
            get_querylog();

            //Get user instance list
            $(function () {
                $.ajax({
                    type: "get",
                    url: "/group/user_all_instances/",
                    dataType: "json",
                    data: {
                        tag_codes: ['can_read']
                    },
                    complete: function () {
                        
                        $("#instance_name").selectpicker('val', sessionStorage.getItem('sql_query_instance_name'));
                        if ($("#instance_name").val()) {
                            $("#instance_name").selectpicker().trigger("change");
                        }
                    },
                    success: function (data) {
                        if (data.status === 0) {
                            $("optgroup[id^='optgroup']").empty();
                            let result = data['data']
                            const supportDb = [ {% for name in engines.keys %}"{{ name }}", {% endfor %}]
                            for (let i of result) {
                                let instance = "<option value=\"" + i.instance_name + "\" instance-id=" + i.id + ">" + i.instance_name + "</option>";
                                if (supportDb.indexOf(i.db_type) !== -1) {
                                    console.log("get supported db")
                                    console.log(i)
                                    $("#optgroup-" + i.db_type).append(instance);
                                }
                            }
                            $('#instance_name').selectpicker('render').selectpicker('refresh');
                            $("#db_name").empty().selectpicker('render').selectpicker('refresh');
                        } else {
                            alert(data.msg);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(errorThrown);
                    }
                });
            });
        });

        function show(o) {
            let allHelpPages = ["keyHelp", "stringHelp", "hashHelp", "setHelp", "zsetHelp"]
            allHelpPages.forEach(function (item) {
                document.getElementById(item).style.display = "none";
            })
            switch(o.value) {
                case "key":
                    document.getElementById("keyHelp").style.display = "block";
                    break;
                case "string":
                    document.getElementById("stringHelp").style.display = "block";
                    break;
                case "hash":
                    document.getElementById("hashHelp").style.display = "block";
                    break;
                case "set":
                    document.getElementById("setHelp").style.display = "block";
                    break;
                case "zset":
                    document.getElementById("zsetHelp").style.display = "block";
                    break;
                default:
                    break;
            }
        }
    </script>
{% endblock %}

