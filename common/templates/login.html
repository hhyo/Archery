<!DOCTYPE html>
<html>
<head>
    <title>{% load i18n %}{% trans "Login To Archery" %}{{ custom_title_suffix }}</title>
    {% load static %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'dist/css/login.css' %}" rel="stylesheet">
    <!--[if lt IE 9]>
         <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
         <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
      <![endif]-->
    <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" />
    <style>
        .language-selector {
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .language-selector select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body style="background-color:#edeff1;">
{% load i18n %}

<!-- Language Selector -->
<div class="language-selector">
    <form action="{% url 'set_language' %}" method="post" id="language-form">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.path }}">
        <select name="language" onchange="this.form.submit()">
            {% get_current_language as LANGUAGE_CODE %}
            {% get_available_languages as LANGUAGES %}
            {% for lang_code, lang_name in LANGUAGES %}
                <option value="{{ lang_code }}" {% if lang_code == LANGUAGE_CODE %}selected{% endif %}>
                    {{ lang_name }}
                </option>
            {% endfor %}
        </select>
    </form>
</div>

<div class="row lsb-login">
    <div class="col-sm-4 login-form-wrapper">
        <h3 class="text-center">{% trans "Login To Archery" %}{{ custom_title_suffix }}</h3>
        <form class="login-form fade-in-effect" id="login" method="post" role="form">
            {% csrf_token %}
            {% if dingding_enabled %}
                <div class="form-group">
                    <a class="btn btn-primary btn-block" role="button" href="/dingding/authenticate/">{% trans "Login with DingTalk" %}</a>
                </div>
            {% elif oidc_enabled %}
                <div class="form-group">
                    <a class="btn btn-primary btn-block" role="button" href="/oidc/authenticate/">{{ oidc_btn_name }}</a>
                </div>
            {% elif cas_enabled %}
            <div class="form-group">
                <a class="btn btn-primary btn-block" role="button" href="/cas/authenticate/">{% trans "CAS Login" %}</a>
            </div>
            {% endif %}
            {% if dingding_enabled or oidc_enabled %}
                <a data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                  {% trans "Show traditional login" %}
                </a>
                <div class="collapse" id="collapseExample">
                  <div>
                    {% include 'legacy_login_form.html' %}
                  </div>
                </div>
            {% else %}
                {% include 'legacy_login_form.html' %}
            {% endif %}
            {% if sign_up_enabled %}
                <div class="form-group">
                    <a href="#" data-toggle="modal" data-target="#sign-up">{% trans "Register" %}</a>
                </div>
            {% endif %}
        </form>
    </div>
</div>

<!-- Registration Modal -->
<div class="modal fade" id="sign-up" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">{% trans "Create Account" %}</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" autocomplete="off"
                           class="form-control" id="username" placeholder="{% trans "Username" %}">
                </div>
                <div class="form-group">
                    <input type="text" autocomplete="off"
                           class="form-control" id="display" placeholder="{% trans "Display Name" %}">
                </div>
                <div class="form-group">
                    <input type="text" autocomplete="off"
                           class="form-control" id="email" placeholder="{% trans "Email" %}">
                </div>
                <div class="form-group">
                    <input type="password"
                           class="form-control" id="password" placeholder="{% trans "Password" %}">
                </div>
                <div class="form-group">
                    <input type="password"
                           class="form-control" autocomplete="new-password" id="password2"
                           placeholder="{% trans "Confirm Password" %}">
                </div>

                <div class="form-group">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                <button id="btnSign" type="submit" class="btn btn-success">{% trans "Register" %}</button>
            </div>
        </div>
    </div>
</div>


<!-- Alert Modal -->
<div class="modal fade" id="wrongpwd-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    {% trans "Notice" %}
                </h4>
            </div>
            <div class="modal-body" id="wrongpwd-modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">{% trans "OK" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="user-bottom-div">
    <p><strong>&copy; Archery</strong>&nbsp;(v{{ archery_version }})</p>
</div>
<script src="{% static 'jquery/jquery.min.js' %}"></script>
<script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>
</body>
<script>
    $(function () {
        $.ajaxSetup({
            headers: {"X-CSRFToken": getCookie("csrftoken")}
        });
    });

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
<script>
    $(document).ready(function () {
        sessionStorage.clear();
    });

    $(document).ready(function () {
        $(document).keydown(function (event) {
            console.log($("#sign-up").css("display"))
            if (event.keyCode === 13 && $("#sign-up").css("display") === 'none') {
                $('#btnLogin').addClass('disabled');
                $('#btnLogin').prop('disabled', true);
                let username = $('#inputUsername').val();
                let password = $('#inputPassword').val();
                authenticateUser(username, password);
            }
        });
    });

    $('#btnLogin').click(function () {
        $('#btnLogin').addClass('disabled');
        $('#btnLogin').prop('disabled', true);
        username = $('#inputUsername').val();
        password = $('#inputPassword').val();
        authenticateUser(username, password);
    });

    // Translatable messages
    var MSG_REGISTRATION_SUCCESS = "{% trans 'Registration successful! Please login.' %}";

    $('#btnSign').click(function () {
        $('#btnSign').addClass('disabled');
        $('#btnSign').prop('disabled', true);
        $.ajax({
            type: "post",
            url: "/signup/",
            dataType: "json",
            data: {
                username: $("#username").val(),
                password: $("#password").val(),
                password2: $("#password2").val(),
                display: $("#display").val(),
                email: $("#email").val(),
            },
            complete: function () {
                $('#btnSign').removeClass('disabled');
                $('#btnSign').prop('disabled', false);
            },
            success: function (data) {
                if (data.status === 0) {
                    $("#sign-up").modal('hide');
                    alert(MSG_REGISTRATION_SUCCESS);
                } else {
                    alert(data.msg);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert(errorThrown);
            }
        });
    });

    function authenticateUser(username, password) {
        $.ajax({
            type: "post",
            url: "/authenticate/",
            dataType: "json",
            data: {
                username: username,
                password: password
            },
            complete: function () {
                $('#btnLogin').removeClass('disabled');
                $('#btnLogin').prop('disabled', false);
            },
            success: function (data) {
                if (data.status === 0) {
                    if (data.data) {
                        document.cookie = "sessionid=" + data.data
                        $(location).attr('href', '/login/2fa/');
                    } else {
                        $(location).attr('href', '/index/');
                    }
                } else {
                    $('#wrongpwd-modal-body').html(data.msg);
                    $('#wrongpwd-modal').modal({
                        keyboard: true
                    });
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert(errorThrown);
            }
        });
    };
</script>
</html>
